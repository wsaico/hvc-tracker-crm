<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVC Tracker CRM - Sistema de Gesti√≥n de Pasajeros de Alto Valor</title>

    <!-- Tailwind CSS - CDN para desarrollo (ignorar warning de producci√≥n) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase CDN -->
    <script>
        // Precargar configuraci√≥n antes de cargar Supabase
        window.SUPABASE_CONFIG = {
            url: 'https://lujzsozkykmfbqhzgkel.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1anpzb3preWttZmJxaHpna2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NjA0MjEsImV4cCI6MjA3NjQzNjQyMX0.a_-8nWKflLdFZxmC3uUcM75fcdTd3kWZaOmjB4adrko'
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Loading indicator -->
    <div id="loading" class="fixed inset-0 bg-blue-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="spinner mb-4"></div>
            <h2 class="text-xl font-semibold">Cargando HVC Tracker...</h2>
            <p class="text-blue-100 mt-2">Inicializando aplicaci√≥n</p>
        </div>
    </div>

    <!-- Estilos CSS -->
    <link rel="stylesheet" href="./styles/main.css">
</head>
<body class="bg-gray-50">
    <!-- Main App Container -->
    <div id="app"></div>

    <!-- M√≥dulos ES6 -->
    <script>
        // Funci√≥n de respaldo inmediata - mostrar algo b√°sico
        function showBasicContent() {
            console.log('üöÄ Emergency mode activated');
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">HVC Tracker</h1>
                        <p class="text-gray-600 mb-6">Sistema de Gesti√≥n de Pasajeros de Alto Valor</p>

                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                            <p class="text-sm text-yellow-700">
                                <strong>Estado:</strong> Aplicaci√≥n b√°sica cargada
                            </p>
                            <p class="text-sm text-yellow-600 mt-1">
                                Hay problemas t√©cnicos. Contacta al administrador.
                            </p>
                        </div>

                        <div class="space-y-3">
                            <div class="text-sm text-gray-500">
                                <strong>Debug Info:</strong><br>
                                URL: ${window.location.href}<br>
                                UserAgent: ${navigator.userAgent.substring(0, 50)}...<br>
                                Timestamp: ${new Date().toISOString()}
                            </div>

                            <button onclick="window.location.reload()"
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                                üîÑ Recargar P√°gina
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Intentar inicializaci√≥n completa
        async function initializeApp() {
            console.log('üöÄ Starting HVC Tracker initialization...');

            try {
                // Verificar dependencias cr√≠ticas
                console.log('üì¶ Checking dependencies...');

                // Timeout de seguridad - si no carga en 10 segundos, mostrar b√°sico
                const timeout = setTimeout(() => {
                    console.warn('‚è∞ Initialization timeout - showing basic content');
                    showBasicContent();
                }, 10000);

                if (typeof window.supabase === 'undefined') {
                    console.warn('‚ö†Ô∏è Supabase library not loaded, waiting...');
                    await new Promise(resolve => {
                        const checkSupabase = () => {
                            if (typeof window.supabase !== 'undefined') {
                                resolve();
                            } else {
                                setTimeout(checkSupabase, 100);
                            }
                        };
                        checkSupabase();
                    });
                }
                console.log('‚úÖ Supabase library loaded');

                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase configuration not found.');
                }
                console.log('‚úÖ Supabase config available');

                // Limpiar timeout ya que tenemos dependencias
                clearTimeout(timeout);

                // Intentar importar m√≥dulos con timeout
                console.log('üìÇ Loading application modules...');
                const modulePromise = import('./src/app.js');
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Module load timeout')), 5000)
                );

                const App = await Promise.race([modulePromise, timeoutPromise]);
                console.log('‚úÖ Modules loaded successfully');

                // Exponer App globalmente
                window.App = App;

                // Probar conexi√≥n a base de datos antes de inicializar
                console.log('üîå Testing database connection...');
                const { createClient } = window.supabase;
                const testClient = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

                try {
                    const { data, error } = await testClient
                        .from('airports')
                        .select('*')
                        .limit(1);

                    if (error) {
                        console.warn('‚ö†Ô∏è Database not available:', error.message);
                        window.DB_AVAILABLE = false;
                    } else {
                        console.log('‚úÖ Database available with data');
                        window.DB_AVAILABLE = true;
                    }
                } catch (dbError) {
                    console.warn('‚ö†Ô∏è Database connection failed:', dbError.message);
                    window.DB_AVAILABLE = false;
                }

                // Inicializar aplicaci√≥n
                console.log('‚öôÔ∏è Initializing application...');
                await App.init();
                console.log('‚úÖ App initialized successfully');

                // Ocultar loading con animaci√≥n
                setTimeout(() => {
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.opacity = '0';
                        setTimeout(() => {
                            loading.style.display = 'none';
                            console.log('üéâ Application ready!');
                        }, 300);
                    }
                }, 500);

            } catch (error) {
                console.error('üí• Critical error during initialization:', error);

                // Ocultar loading
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.display = 'none';
                }

                // Mostrar contenido b√°sico de respaldo
                showBasicContent();
                return; // Agregar return para evitar continuar con c√≥digo inv√°lido
            }
        }

        // Inicializar cuando DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM Content Loaded');
                initializeApp();
            });
        } else {
            console.log('üìÑ DOM Already Loaded');
            initializeApp();
        }

        // Verificaci√≥n adicional cuando window est√© completamente cargado
        window.addEventListener('load', () => {
            console.log('üåê Window fully loaded');
            console.log('üîß Supabase available:', typeof window.supabase !== 'undefined');
            console.log('üé® Tailwind available:', typeof window.tailwind !== 'undefined');
            console.log('‚öôÔ∏è Config available:', !!window.SUPABASE_CONFIG);
        });

        // √öltimo respaldo - si despu√©s de 15 segundos a√∫n no hay contenido, mostrar b√°sico
        setTimeout(() => {
            const app = document.getElementById('app');
            if (app && !app.innerHTML.trim()) {
                console.warn('üö® Emergency fallback activated');
                showBasicContent();
            }
        }, 15000);
    </script>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-gray-200 py-2 px-4 z-40">
        <div class="text-center">
            <p class="text-xs text-gray-500">
                Desarrollado con ‚ô•Ô∏è por <a href="https://wsaico.com" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium">wsaico.com</a>
            </p>
        </div>
    </footer>
</body>
</html>
